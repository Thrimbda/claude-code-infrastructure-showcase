# LegionMind系统 - 实施计划

## 执行摘要

LegionMind是一个为Claude Code设计的跨会话多代理协作系统，旨在解决AI辅助软件开发中的核心问题：

1. **状态丢失与重复工作** - 代理在不同会话中重新探索相同的上下文
2. **缺乏统一真相源（SoT）** - 任务状态分散在聊天记录、问题、第三方系统中
3. **高监督成本** - 人类必须频繁阅读长对话来理解代理做了什么
4. **上下文与注意力稀释** - 长篇规则和历史被后续内容淹没

LegionMind将任务管理直接嵌入文件系统和Git仓库（文件系统原生任务管理），使人类和AI能够使用相同的状态文件和规则文件。

**主要价值主张**：使多个代理能够在跨会话的大型项目上协调工作，具有共享上下文和结构化状态管理。

## 当前状态分析

### 现有基础设施（Claude Code展示项目）

**技能系统**:
- 5个通过hooks自动激活的核心技能
- 技能规则配置（`.claude/skills/skill-rules.json`）
- 渐进式披露模式（500行规则）

**Hooks系统**:
- `skill-activation-prompt` (UserPromptSubmit) - 自动建议相关技能
- `post-tool-use-tracker` (PostToolUse) - 跟踪文件修改
- 多个Stop hooks用于质量控制

**代理系统**:
- 10个用于不同任务的专业代理（代码审查、重构、文档等）
- 代理定义在 `.claude/agents/`

**MCP服务器**:
- 启用的mysql、sequential-thinking、playwright
- 设置中的MCP服务器配置

**开发文档模式**:
- 用于跨会话上下文保存的三文件结构
- `/dev-docs` 斜杠命令用于计划创建
- 活动/归档目录结构

### LegionMind解决的差距

1. **无结构化状态管理**: 当前状态仅存在于聊天记录中
2. **无代理协调**: 代理独立工作，没有共享上下文
3. **无任务跟踪**: 没有跨会话跟踪任务进度的系统方法
4. **无决策记录**: 关键决策在对话历史中丢失
5. **无人类监督界面**: 难以监控代理活动

## 提议的未来状态

### 愿景
一个统一的状态管理系统，其中：
- 项目状态存储在版本控制的JSON文件中
- 任务具有结构化生命周期（待办 → 进行中 → 审查 → 完成）
- 代理注册其活动并更新共享状态
- 人类可以通过结构化报告监控进度
- 决策被记录且可搜索
- 上下文加载被优化（核心层 vs 扩展层）

### 关键组件

1. **LegionMind技能** - 使用指南和集成文档
2. **LegionMind MCP服务器** - 用于状态读/写、任务管理、协调的工具
3. **LegionMind Hooks** - 自动状态更新和上下文注入
4. **LegionMind代理** - 协调器、审计员、报告员代理
5. **LegionMind状态目录** - 文件系统原生状态存储

### 集成点
- 扩展现有技能激活系统
- 与 `/dev-docs` 模式集成
- 与现有专业代理协同工作
- 与当前hooks基础设施兼容

## 实施阶段

### 阶段1: 基础与核心状态管理（第1周）
**目标**: 建立基础状态结构和技能框架

**时长**: 3-4天
**工作量**: L
**依赖**: 无

**关键交付物**:
1. 带基础文档的LegionMind技能
2. 核心状态文件结构 (`legionmind/` 目录)
3. 带状态读写工具的基础MCP服务器
4. 会话初始化hook

### 阶段2: 任务管理系统（第2周）
**目标**: 实现完整的任务生命周期和协调

**时长**: 4-5天
**工作量**: XL
**依赖**: 阶段1

**关键交付物**:
1. 包含所有状态的完整任务模型
2. 任务创建、分配、更新工具
3. 任务协调机制
4. 与 `/dev-docs` 系统集成

### 阶段3: 代理集成与协调（第3周）
**目标**: 启用多代理协作和共享上下文

**时长**: 3-4天
**工作量**: L
**依赖**: 阶段2

**关键交付物**:
1. 代理注册和状态跟踪
2. 任务分配和冲突解决
3. 上下文共享机制
4. 与现有代理集成

### 阶段4: 人类监督与高级功能（第4周）
**目标**: 添加监督界面和高级功能

**时长**: 3-4天
**工作量**: M
**依赖**: 阶段3

**关键交付物**:
1. 状态报告和仪表板
2. 决策记录系统
3. 审计跟踪与分类账
4. 性能指标和分析

## 详细任务

### 阶段1: 基础与核心状态管理

#### 任务1.1: 创建LegionMind技能结构
**描述**: 遵循500行规则和渐进式披露模式创建LegionMind技能
**验收标准**:
- `.claude/skills/legionmind/` 下的 `SKILL.md` 文件（<500行）
- 包含概述、核心概念、使用示例的基础结构
- 与现有技能激活系统集成
- 测试技能在相关时出现在建议中

**工作量**: M
**依赖**: 无

#### 任务1.2: 设计状态文件模式
**描述**: 为所有状态文件定义JSON模式
**验收标准**:
- 设计文档中的完整模式文档
- 模式验证示例
- 向后兼容性考虑
- 未来变更的迁移路径

**工作量**: S
**依赖**: 任务1.1

#### 任务1.3: 实现核心状态目录结构
**描述**: 创建带初始状态文件的 `legionmind/` 目录
**验收标准**:
- 在项目根目录创建目录结构
- 包含基础项目元数据的 `state.json`
- 空的子目录 (tasks, agents, decisions, ledger)
- 启用状态文件的Git跟踪
- 说明文件用途的 README

**工作量**: S
**依赖**: 任务1.2

#### 任务1.4: 创建基础MCP服务器
**描述**: 实现带核心状态管理工具的MCP服务器
**验收标准**:
- 服务器在Claude Code中注册
- `read_project_state` 工具 - 读取核心状态
- `update_project_state` 工具 - 更新特定字段
- `get_status_summary` 工具 - 提供高级概览
- 错误处理和验证

**工作量**: L
**依赖**: 任务1.3

#### 任务1.5: 实现会话初始化Hook
**描述**: 在会话开始时加载LegionMind上下文的hook
**验收标准**:
- 检测新会话的UserPromptSubmit hook
- 将项目状态摘要注入上下文
- 在相关时激活LegionMind技能
- 可配置的注入级别 (摘要/详细/无)

**工作量**: M
**依赖**: 任务1.4

### 阶段2: 任务管理系统

#### 任务2.1: 实现任务模型
**描述**: 完成任务状态文件和管理实现
**验收标准**:
- 包含所有字段的 `tasks/{task-id}.json` 模式
- 带唯一ID生成的任务创建
- 任务状态转换（待办 → 进行中 → 审查 → 完成）
- 任务依赖和约束的验证
- 任务归档和清理

**工作量**: L
**依赖**: 阶段1完成

#### 任务2.2: 使用任务工具扩展MCP服务器
**描述**: 向MCP服务器添加任务管理工具
**验收标准**:
- `create_task` - 使用元数据创建新任务
- `update_task_status` - 更新任务状态
- `get_task` - 检索任务详情
- `list_tasks` - 过滤和搜索任务
- `assign_task` - 将任务分配给代理

**工作量**: M
**依赖**: 任务2.1

#### 任务2.3: 实现任务协调机制
**描述**: 任务分配、冲突解决、依赖关系的工具
**验收标准**:
- 依赖验证（防止循环依赖）
- 冲突检测（多个代理在同一任务上）
- 跨可用代理的负载均衡
- 基于优先级的任务调度
- 阻塞任务处理

**工作量**: L
**依赖**: 任务2.2

#### 任务2.4: 与/dev-docs系统集成
**描述**: 同步LegionMind任务与开发文档结构
**验收标准**:
- 为复杂任务自动创建开发文档
- `plan.md` 与任务状态之间的同步
- `tasks.md` 检查清单与任务完成之间的同步
- 跨两个系统的上下文保存
- 现有开发文档的迁移路径

**工作量**: M
**依赖**: 任务2.3

### 阶段3: 代理集成与协调

#### 任务3.1: 实现代理状态跟踪
**描述**: 跟踪代理活动、能力和性能
**验收标准**:
- `agents/{agent-id}.json` 模式
- 会话开始时的代理注册
- 活动日志记录（使用的工具、处理的任务）
- 能力跟踪（技能、专业领域）
- 性能指标（完成率、每任务时间）

**工作量**: M
**依赖**: 阶段2完成

#### 任务3.2: 创建代理协调系统
**描述**: 代理发现和协调工作的机制
**验收标准**:
- 代理可用性检查
- 基于代理能力的任务分配
- 多个代理想要同一任务时的冲突解决
- 代理之间的进度同步
- 复杂任务的交接协议

**工作量**: L
**依赖**: 任务3.1

#### 任务3.3: 与现有专业代理集成
**描述**: 使现有代理能够使用LegionMind系统
**验收标准**:
- Code-architecture-reviewer在审查后更新任务状态
- Documentation-architect记录文档任务
- Frontend-error-fixer跟踪bug修复
- 所有代理可以读取项目状态
- 跨代理类型的一致接口

**工作量**: M
**依赖**: 任务3.2

#### 任务3.4: 实现上下文共享系统
**描述**: 代理之间的高效上下文共享
**验收标准**:
- 用于交接的上下文摘要
- 基于优先级的上下文加载
- 共享决策历史访问
- 上下文版本控制和差异比较
- 代理会话之间的隐私边界

**工作量**: L
**依赖**: 任务3.3

### 阶段4: 人类监督与高级功能

#### 任务4.1: 创建状态报告系统
**描述**: 生成人类可读的状态报告和仪表板
**验收标准**:
- 每日/每周摘要报告
- 项目健康仪表板（任务、阻塞项、进度）
- 代理活动报告
- 可自定义的报告模板
- 导出到markdown、JSON、CSV格式

**工作量**: M
**依赖**: 阶段3完成

#### 任务4.2: 实现决策记录系统
**描述**: 关键架构和设计决策的结构化日志记录
**验收标准**:
- `decisions/{decision-id}.md` 格式
- 决策元数据（谁、何时、为什么、考虑的替代方案）
- 决策影响跟踪
- 按标签、日期、作者搜索和过滤
- 决策审查和撤销流程

**工作量**: M
**依赖**: 任务4.1

#### 任务4.3: 创建审计跟踪与分类账
**描述**: 所有系统活动的完整审计跟踪
**验收标准**:
- `ledger/{date}.json` 每日活动日志
- 行动记录（谁、做了什么、何时、使用什么参数）
- 状态文件的变更跟踪
- 完整性验证机制
- 符合审计要求

**工作量**: L
**依赖**: 任务4.2

#### 任务4.4: 实现性能分析
**描述**: 用于持续改进的指标收集和分析
**验收标准**:
- 效率指标（相比手动节省的时间）
- 质量指标（任务成功率、错误率）
- 代理性能比较
- 瓶颈识别
- 任务估算的预测分析

**工作量**: M
**依赖**: 任务4.3

## 风险评估和缓解策略

### 风险1: 状态文件损坏或冲突
**描述**: 对状态文件的并发写入可能导致损坏或冲突
**概率**: 中等
**影响**: 高
**缓解措施**:
- 实现文件锁定机制
- 使用带版本号的乐观并发控制
- 提供冲突解决工具
- 定期自动备份
- 原子写入操作

### 风险2: 大型项目性能下降
**描述**: 状态文件可能变得过大，减慢读/写速度
**概率**: 中等
**影响**: 中等
**缓解措施**:
- 实现分页和延迟加载
- 使用增量更新而非完全重写
- 将旧数据归档到单独文件
- 为频繁读取实现缓存
- 提供清理和优化工具

### 风险3: 现有用户的采用阻力
**描述**: 用户可能抵制改变工作流程以使用LegionMind
**概率**: 高
**影响**: 中等
**缓解措施**:
- 渐进采用路径（可选功能）
- 与现有工作流程向后兼容
- 用指标清晰展示价值
- 优秀的文档和示例
- 社区反馈整合

### 风险4: 复杂性过载
**描述**: 系统可能变得过于复杂，用户难以理解
**概率**: 中等
**影响**: 中等
**缓解措施**:
- 功能的渐进式披露
- 开箱即用的合理默认值
- 引导式入门体验
- 常见用例的简化视图
- 定期可用性测试

### 风险5: 与Claude Code更新的集成问题
**描述**: Claude Code的更改可能破坏LegionMind集成
**概率**: 低
**影响**: 高
**缓解措施**:
- 遵循Claude Code最佳实践和模式
- 对未记录功能的最小依赖
- 全面的测试套件
- 主动监控Claude Code发布
- 针对破坏性变更的应急计划

## 成功指标

### 定量指标
1. **任务完成时间**: 从任务创建到完成的时间减少（目标：减少30%）
2. **上下文加载时间**: 重置后重新探索上下文的时间减少（目标：减少80%）
3. **人类监督时间**: 人类监控代理活动的时间减少（目标：减少50%）
4. **任务成功率**: 成功任务完成的增加（目标：95%成功率）
5. **代理利用率**: 代理工作负载分布的改进（目标：<20%空闲时间）

### 定性指标
1. **用户满意度**: 使用系统的开发者的反馈
2. **采用率**: 使用LegionMind功能的项目百分比
3. **错误减少**: 由于丢失上下文或沟通错误导致的错误减少
4. **决策质量**: 由于适当记录而更好的架构决策
5. **团队协调**: 人类和AI团队成员之间协作的改进

## 所需资源和依赖

### 技术资源
1. **Claude Code环境**: 支持MCP服务器的最新版本
2. **Node.js**: v18+ 用于MCP服务器实现
3. **TypeScript**: 用于类型安全实现
4. **Git**: 用于状态文件的版本控制
5. **文件系统**: 对项目目录的读/写访问权限

### 人力资源
1. **首席开发人员**: 4周50%的时间分配
2. **UX/技术文档撰写者**: 25%的时间用于文档和用户体验
3. **QA/测试**: 25%的时间用于测试和验证
4. **早期采用者**: 用于反馈和试点测试

### 外部依赖
1. **Claude Code API稳定性**: 一致的hooks和MCP接口
2. **社区技能**: 与流行的第三方技能兼容
3. **项目结构**: 遵循常见项目模式

## 时间线估计

### 总体时间线: 4周
**第1周**: 基础与核心状态管理
**第2周**: 任务管理系统
**第3周**: 代理集成与协调
**第4周**: 人类监督与高级功能

### 详细每周计划

#### 第1周（基础）
- **第1-2天**: 技能创建和模式设计
- **第3-4天**: 状态目录和基础MCP服务器
- **第5天**: 会话初始化hook和测试

#### 第2周（任务管理）
- **第6-7天**: 完成任务模型实现
- **第8-9天**: MCP任务工具和协调
- **第10天**: 与开发文档系统集成

#### 第3周（代理集成）
- **第11-12天**: 代理状态跟踪和协调
- **第13-14天**: 与现有代理集成
- **第15天**: 上下文共享系统

#### 第4周（高级功能）
- **第16-17天**: 状态报告和决策记录
- **第18-19天**: 审计跟踪和性能分析
- **第20天**: 最终测试、文档、发布准备

### 应急缓冲: 1周
额外一周用于应对意外挑战、改进和润色。

## 下一步

1. **与利益相关者审查此计划**以确保一致性
2. **开始阶段1实施**（任务1.1: 创建LegionMind技能结构）
3. **设置每周检查点**以审查进度并根据需要调整
4. **确定试点项目**用于早期测试和反馈
5. **建立指标跟踪**以根据定义的目标衡量成功

---

**最后更新**: 2025-12-11 (上下文重置前更新)
**计划版本**: 1.0
**状态**: 设计完成 - 准备开始实施阶段1