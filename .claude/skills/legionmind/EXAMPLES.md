# LegionMind Examples

å®Œæ•´çš„ä¸‰æ–‡ä»¶ç¤ºä¾‹ï¼Œå¯ç›´æ¥å‚è€ƒä½¿ç”¨ã€‚

---

## Table of Contents

1. [config.json Example](#configjson-example)
2. [plan.md Example](#planmd-example)
3. [context.md Example](#contextmd-example)
4. [tasks.md Example](#tasksmd-example)
5. [Complete Directory Structure](#complete-directory-structure)

---

## config.json Example

```json
{
  "$schema": "./config.schema.json",
  "version": "1.0.0",
  "currentTask": "shi-xian-yong-hu-ren-zheng",
  "settings": {
    "autoRemind": true,
    "remindBeforeReset": true
  },
  "tasks": [
    {
      "id": "shi-xian-yong-hu-ren-zheng",
      "name": "å®ç°ç”¨æˆ·è®¤è¯æ¨¡å—",
      "status": "active",
      "createdAt": "2025-12-12T10:00:00Z",
      "updatedAt": "2025-12-12T14:30:00Z"
    },
    {
      "id": "xing-neng-wen-ti-pai-cha",
      "name": "æ€§èƒ½é—®é¢˜æ’æŸ¥ï¼ˆæ”¯ä»˜é“¾è·¯ï¼‰",
      "status": "paused",
      "createdAt": "2025-12-11T09:00:00Z",
      "updatedAt": "2025-12-11T18:00:00Z"
    },
    {
      "id": "refactor-database-layer",
      "name": "Refactor Database Layer",
      "status": "completed",
      "createdAt": "2025-12-10T08:00:00Z",
      "updatedAt": "2025-12-10T17:00:00Z"
    }
  ]
}
```

---

## plan.md Example

```markdown
# å®ç°ç”¨æˆ·è®¤è¯æ¨¡å—

## ç›®æ ‡

å®ç°åŸºäº JWT çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿï¼Œæ”¯æŒç™»å½•ã€ç™»å‡ºã€token åˆ·æ–°ï¼Œé›†æˆç°æœ‰çš„ Keycloak ä½œä¸ºèº«ä»½æä¾›è€…ã€‚

## è¦ç‚¹

- **æŠ€æœ¯é€‰å‹**: JWT + RS256 ç®—æ³•ï¼Œæ”¯æŒå…¬é’¥éªŒè¯
- **å…³é”®çº¦æŸ**: å¿…é¡»å…¼å®¹ç°æœ‰ Keycloak é›†æˆ
- **å®‰å…¨è¦æ±‚**: Token è¿‡æœŸæ—¶é—´ 15 åˆ†é’Ÿï¼Œåˆ·æ–° token ä½¿ç”¨ httpOnly cookie
- **æ€§èƒ½ç›®æ ‡**: è®¤è¯æ¥å£ p99 < 100ms
- **é£é™©ç‚¹**: å¹¶å‘åˆ·æ–° token å¯èƒ½å¯¼è‡´ç«æ€æ¡ä»¶

## èŒƒå›´

å°†æ”¹åŠ¨ä»¥ä¸‹æ–‡ä»¶/æ¨¡å—ï¼š

- `src/auth/` - æ–°å»ºè®¤è¯æ¨¡å—
  - `jwt.ts` - JWT å·¥å…·
  - `middleware.ts` - è®¤è¯ä¸­é—´ä»¶
  - `routes.ts` - è®¤è¯è·¯ç”±
- `src/config/` - æ·»åŠ  JWT é…ç½®
- `prisma/schema.prisma` - æ·»åŠ  RefreshToken æ¨¡å‹
- `tests/auth/` - è®¤è¯æµ‹è¯•

## é˜¶æ®µæ¦‚è§ˆ

1. **åŸºç¡€è®¾æ–½** - JWT å·¥å…·ã€å¯†é’¥ç®¡ç†ã€åŸºç¡€é…ç½®
2. **æ ¸å¿ƒå®ç°** - ç™»å½•ã€ç™»å‡ºã€token åˆ·æ–°æ¥å£
3. **å®‰å…¨åŠ å›º** - é»‘åå•ã€rate limitingã€é”™è¯¯è¿½è¸ª
4. **æµ‹è¯•éªŒè¯** - å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•

---

*åˆ›å»ºäº: 2025-12-12 | æœ€åæ›´æ–°: 2025-12-12*
```

---

## context.md Example

```markdown
# å®ç°ç”¨æˆ·è®¤è¯æ¨¡å— - ä¸Šä¸‹æ–‡

## ä¼šè¯è¿›å±• (2025-12-12)

### âœ… å·²å®Œæˆ

- åˆ›å»ºäº† JWT å·¥å…·æ¨¡å— (`src/auth/jwt.ts`)
  - å®ç°äº† `generateToken()` å’Œ `verifyToken()`
  - ä½¿ç”¨ RS256 ç®—æ³•ï¼Œå¯†é’¥ä»ç¯å¢ƒå˜é‡è¯»å–
- åˆ›å»ºäº†è®¤è¯ä¸­é—´ä»¶ (`src/middleware/auth.ts`)
  - ä» Authorization header æå– token
  - éªŒè¯å¤±è´¥è¿”å› 401
- å®ç°äº†ç™»å½•æ¥å£ (`POST /auth/login`)
  - éªŒè¯ç”¨æˆ·å‡­è¯ï¼ˆå¯¹æ¥ Keycloakï¼‰
  - è¿”å› access_token å’Œ refresh_token
- æ·»åŠ äº†åŸºç¡€å•å…ƒæµ‹è¯•
  - jwt.test.ts: 10 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œå…¨éƒ¨é€šè¿‡

### ğŸŸ¡ è¿›è¡Œä¸­

- å®ç° token åˆ·æ–°é€»è¾‘
  - æ–‡ä»¶: `src/auth/routes.ts`
  - æ–¹æ³•: `POST /auth/refresh`
  - å½“å‰çŠ¶æ€: æ¡†æ¶å·²æ­å»ºï¼Œæ ¸å¿ƒé€»è¾‘å¾…å®ç°

### âš ï¸ é˜»å¡/å¾…å®š

- éœ€è¦ç¡®è®¤ï¼šåˆ·æ–° token çš„è¿‡æœŸæ—¶é—´è®¾ä¸ºå¤šä¹…ï¼Ÿï¼ˆå»ºè®® 7 å¤©ï¼‰
- å¾…å®šï¼šæ˜¯å¦éœ€è¦æ”¯æŒå¤šè®¾å¤‡åŒæ—¶ç™»å½•ï¼Ÿ

---

## å…³é”®æ–‡ä»¶

**`src/auth/jwt.ts`** [å·²å®Œæˆ]
- ä½œç”¨ï¼šJWT ç”Ÿæˆå’ŒéªŒè¯å·¥å…·
- æ³¨æ„ï¼šä½¿ç”¨ RS256 ç®—æ³•ï¼Œç§é’¥åœ¨ `JWT_PRIVATE_KEY` ç¯å¢ƒå˜é‡

**`src/auth/routes.ts`** [è¿›è¡Œä¸­]
- ä½œç”¨ï¼šè®¤è¯ç›¸å…³çš„ API è·¯ç”±
- æ³¨æ„ï¼š`/refresh` æ¥å£éœ€è¦æ£€æŸ¥ token é»‘åå•

**`src/middleware/auth.ts`** [å·²å®Œæˆ]
- ä½œç”¨ï¼šè®¤è¯ä¸­é—´ä»¶ï¼Œä¿æŠ¤éœ€è¦ç™»å½•çš„è·¯ç”±
- æ³¨æ„ï¼šé”™è¯¯å·²é›†æˆ Sentry ä¸ŠæŠ¥

**`prisma/schema.prisma`** [å¾…ä¿®æ”¹]
- ä½œç”¨ï¼šæ•°æ®åº“æ¨¡å‹å®šä¹‰
- æ³¨æ„ï¼šéœ€è¦æ·»åŠ  RefreshToken æ¨¡å‹

---

## å…³é”®å†³ç­–

| å†³ç­– | åŸå›  | æ›¿ä»£æ–¹æ¡ˆ | æ—¥æœŸ |
|------|------|----------|------|
| ä½¿ç”¨ JWT è€Œé Session | éœ€è¦æ”¯æŒç§»åŠ¨ç«¯å’Œè·¨åŸŸåœºæ™¯ | Session + Redis | 2025-12-12 |
| é€‰æ‹© RS256 ç®—æ³• | æ”¯æŒå…¬é’¥éªŒè¯ï¼Œä¾¿äºå¾®æœåŠ¡æ¶æ„ | HS256ï¼ˆæ›´ç®€å•ä½†éœ€å…±äº«å¯†é’¥ï¼‰ | 2025-12-12 |
| Refresh token å­˜æ•°æ®åº“ | æ”¯æŒä¸»åŠ¨æ’¤é”€å’Œå¤šè®¾å¤‡ç®¡ç† | å­˜ Redisï¼ˆæ›´å¿«ä½†é‡å¯ä¸¢å¤±ï¼‰ | 2025-12-12 |
| Access token 15åˆ†é’Ÿè¿‡æœŸ | å¹³è¡¡å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒ | 1å°æ—¶ï¼ˆå®‰å…¨æ€§è¾ƒä½ï¼‰ | 2025-12-12 |

---

## æŠ€æœ¯çº¦æŸ

- **Keycloak é›†æˆ**ï¼šå¿…é¡»ä½¿ç”¨ç°æœ‰çš„ Keycloak ä½œä¸ºèº«ä»½éªŒè¯åç«¯ï¼Œä¸èƒ½è‡ªå»ºç”¨æˆ·å¯†ç å­˜å‚¨
- **Cookie é™åˆ¶**ï¼šRefresh token å¿…é¡»ä½¿ç”¨ httpOnly + Secure + SameSite=Strict
- **ç¯å¢ƒå˜é‡**ï¼šæ‰€æœ‰å¯†é’¥å¿…é¡»ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œä¸èƒ½ç¡¬ç¼–ç 
- **é”™è¯¯è¿½è¸ª**ï¼šæ‰€æœ‰è®¤è¯é”™è¯¯å¿…é¡»ä¸ŠæŠ¥åˆ° Sentry

---

## ç›¸å…³é“¾æ¥

- è®¾è®¡æ–‡æ¡£: `docs/auth-design.md`
- API è§„èŒƒ: `docs/api/auth.yaml`
- Keycloak æ–‡æ¡£: https://www.keycloak.org/docs/latest/

---

## å¿«é€Ÿäº¤æ¥

**ä¸‹æ¬¡ç»§ç»­ä»è¿™é‡Œå¼€å§‹ï¼š**

1. æ‰“å¼€ `src/auth/routes.ts`
2. æ‰¾åˆ° `POST /auth/refresh` è·¯ç”±
3. å®ç° `refreshToken()` æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘ï¼š
   - ä» cookie ä¸­è¯»å– refresh_token
   - éªŒè¯ token ç­¾å
   - æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•ä¸­
   - ç”Ÿæˆæ–°çš„ access_token
   - ï¼ˆå¯é€‰ï¼‰è½®æ¢ refresh_token
4. æ·»åŠ  RefreshToken æ¨¡å‹åˆ° Prisma schema

**æ³¨æ„äº‹é¡¹ï¼š**

- åˆ·æ–° token æ—¶è¦æ£€æŸ¥é»‘åå•ï¼ˆå°šæœªå®ç°ï¼‰
- å¹¶å‘åˆ·æ–°å¯èƒ½å¯¼è‡´ç«æ€æ¡ä»¶ï¼Œè€ƒè™‘ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡
- è®°å¾—åŒæ­¥æ›´æ–° tasks.md çš„è¿›åº¦

---

*æœ€åæ›´æ–°: 2025-12-12 14:30 by Claude*
```

---

## tasks.md Example

```markdown
# å®ç°ç”¨æˆ·è®¤è¯æ¨¡å— - ä»»åŠ¡æ¸…å•

## å¿«é€Ÿæ¢å¤

**å½“å‰é˜¶æ®µ**: é˜¶æ®µ 2 - æ ¸å¿ƒå®ç°
**å½“å‰ä»»åŠ¡**: å®ç° token åˆ·æ–°é€»è¾‘
**è¿›åº¦**: 5/12 ä»»åŠ¡å®Œæˆ

---

## é˜¶æ®µ 1: åŸºç¡€è®¾æ–½ âœ… COMPLETE

- [x] åˆ›å»º JWT å·¥å…·æ¨¡å— | éªŒæ”¶: `jwt.ts` åŒ…å« `generateToken()` å’Œ `verifyToken()` æ–¹æ³•
- [x] é…ç½®å¯†é’¥ç®¡ç† | éªŒæ”¶: ä» `JWT_PRIVATE_KEY` å’Œ `JWT_PUBLIC_KEY` ç¯å¢ƒå˜é‡è¯»å–
- [x] åˆ›å»ºè®¤è¯ä¸­é—´ä»¶ | éªŒæ”¶: ä¸­é—´ä»¶èƒ½æ­£ç¡®è§£æå’ŒéªŒè¯ Bearer token
- [x] æ·»åŠ åŸºç¡€å•å…ƒæµ‹è¯• | éªŒæ”¶: jwt.test.ts æµ‹è¯•è¦†ç›– sign/verifyï¼Œå…¨éƒ¨é€šè¿‡

---

## é˜¶æ®µ 2: æ ¸å¿ƒå®ç° ğŸŸ¡ IN PROGRESS

- [x] å®ç°ç™»å½•æ¥å£ | éªŒæ”¶: `POST /auth/login` è¿”å› access_token å’Œ refresh_token
- [ ] å®ç° token åˆ·æ–°é€»è¾‘ | éªŒæ”¶: `POST /auth/refresh` æ­£ç¡®ç”Ÿæˆæ–° token â† CURRENT
- [ ] æ·»åŠ  RefreshToken æ•°æ®æ¨¡å‹ | éªŒæ”¶: Prisma schema åŒ…å«æ¨¡å‹ï¼Œmigration æˆåŠŸ
- [ ] å®ç°ç™»å‡ºæ¥å£ | éªŒæ”¶: `POST /auth/logout` å°† token åŠ å…¥é»‘åå•
- [ ] æ·»åŠ  token é»‘åå•æœºåˆ¶ | éªŒæ”¶: é»‘åå•ä¸­çš„ token æ— æ³•åˆ·æ–°

---

## é˜¶æ®µ 3: å®‰å…¨åŠ å›º â³ NOT STARTED

- [ ] é›†æˆ Sentry é”™è¯¯è¿½è¸ª | éªŒæ”¶: è®¤è¯é”™è¯¯è‡ªåŠ¨ä¸ŠæŠ¥åˆ° Sentry
- [ ] æ·»åŠ  rate limiting | éªŒæ”¶: ç™»å½•æ¥å£é™åˆ¶ 5æ¬¡/åˆ†é’Ÿ/IP
- [ ] æ·»åŠ è¯·æ±‚æ—¥å¿— | éªŒæ”¶: æ‰€æœ‰è®¤è¯è¯·æ±‚è®°å½•åˆ°æ—¥å¿—ï¼ˆè„±æ•ï¼‰

---

## é˜¶æ®µ 4: æµ‹è¯•éªŒè¯ â³ NOT STARTED

- [ ] ç«¯åˆ°ç«¯ç™»å½•æµç¨‹æµ‹è¯• | éªŒæ”¶: å®Œæ•´æµç¨‹ï¼ˆç™»å½•â†’è®¿é—®â†’åˆ·æ–°â†’ç™»å‡ºï¼‰é€šè¿‡
- [ ] token è¿‡æœŸåœºæ™¯æµ‹è¯• | éªŒæ”¶: è¿‡æœŸåæ­£ç¡®è¿”å› 401ï¼Œåˆ·æ–°åæ¢å¤
- [ ] å¹¶å‘åˆ·æ–°æµ‹è¯• | éªŒæ”¶: å¤šä¸ªå¹¶å‘åˆ·æ–°è¯·æ±‚æ— ç«æ€æ¡ä»¶
- [ ] æ€§èƒ½æµ‹è¯• | éªŒæ”¶: è®¤è¯æ¥å£ p99 < 100ms

---

## å‘ç°çš„æ–°ä»»åŠ¡

- [ ] æ”¯æŒå¤šè®¾å¤‡ç™»å½•ç®¡ç† | æ¥æº: äº§å“éœ€æ±‚è®¨è®º
- [ ] æ·»åŠ ç™»å½•å†å²è®°å½• | æ¥æº: å®‰å…¨å®¡æŸ¥å»ºè®®
- [ ] å®ç°"è®°ä½æˆ‘"åŠŸèƒ½ | æ¥æº: ç”¨æˆ·åé¦ˆ

---

*æœ€åæ›´æ–°: 2025-12-12 14:30*
```

---

## Complete Directory Structure

ä¸€ä¸ªå®Œæ•´çš„ `.legion/` ç›®å½•ç»“æ„ç¤ºä¾‹ï¼š

```
.legion/
â”œâ”€â”€ config.json
â””â”€â”€ tasks/
    â”œâ”€â”€ shi-xian-yong-hu-ren-zheng/
    â”‚   â”œâ”€â”€ plan.md
    â”‚   â”œâ”€â”€ context.md
    â”‚   â””â”€â”€ tasks.md
    â”œâ”€â”€ xing-neng-wen-ti-pai-cha/
    â”‚   â”œâ”€â”€ plan.md
    â”‚   â”œâ”€â”€ context.md
    â”‚   â””â”€â”€ tasks.md
    â””â”€â”€ refactor-database-layer/
        â”œâ”€â”€ plan.md
        â”œâ”€â”€ context.md
        â””â”€â”€ tasks.md
```

### Minimal Example (Empty Task)

æ–°åˆ›å»ºçš„ä»»åŠ¡ï¼Œä¸‰æ–‡ä»¶çš„åˆå§‹çŠ¶æ€ï¼š

**plan.md**
```markdown
# æ–°ä»»åŠ¡

## ç›®æ ‡

(å¾…å¡«å†™)

## è¦ç‚¹

- (å¾…å¡«å†™)

## èŒƒå›´

- (å¾…å¡«å†™)

## é˜¶æ®µæ¦‚è§ˆ

1. (å¾…å¡«å†™)

---

*åˆ›å»ºäº: 2025-12-12 | æœ€åæ›´æ–°: 2025-12-12*
```

**context.md**
```markdown
# æ–°ä»»åŠ¡ - ä¸Šä¸‹æ–‡

## ä¼šè¯è¿›å±• (2025-12-12)

### âœ… å·²å®Œæˆ

(æš‚æ— )

### ğŸŸ¡ è¿›è¡Œä¸­

(æš‚æ— )

### âš ï¸ é˜»å¡/å¾…å®š

(æš‚æ— )

---

## å…³é”®æ–‡ä»¶

(æš‚æ— )

---

## å…³é”®å†³ç­–

| å†³ç­– | åŸå›  | æ›¿ä»£æ–¹æ¡ˆ | æ—¥æœŸ |
|------|------|----------|------|

---

## å¿«é€Ÿäº¤æ¥

**ä¸‹æ¬¡ç»§ç»­ä»è¿™é‡Œå¼€å§‹ï¼š**

1. (å¾…å¡«å†™)

**æ³¨æ„äº‹é¡¹ï¼š**

- (å¾…å¡«å†™)

---

*æœ€åæ›´æ–°: 2025-12-12 10:00 by Claude*
```

**tasks.md**
```markdown
# æ–°ä»»åŠ¡ - ä»»åŠ¡æ¸…å•

## å¿«é€Ÿæ¢å¤

**å½“å‰é˜¶æ®µ**: (æœªå¼€å§‹)
**å½“å‰ä»»åŠ¡**: (æœªå¼€å§‹)
**è¿›åº¦**: 0/0 ä»»åŠ¡å®Œæˆ

---

## é˜¶æ®µ 1: (å¾…å‘½å) â³ NOT STARTED

- [ ] (å¾…æ·»åŠ ä»»åŠ¡) | éªŒæ”¶: (å¾…å¡«å†™)

---

*æœ€åæ›´æ–°: 2025-12-12 10:00*
```

---

## Related Files

- [SKILL.md](./SKILL.md) - ä¸»æŠ€èƒ½æ–‡ä»¶
- [SCHEMA.md](./SCHEMA.md) - Schema å®šä¹‰
- [MCP_TOOLS.md](./MCP_TOOLS.md) - MCP å·¥å…·æ¥å£
